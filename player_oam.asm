


    ; $68CF0-$???? data relating to shield
    
    ; $68AF1-$???? data relating to sword
    
    ; $698F3-$69AF1
    {
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $09, $05, $FE, $FA
        db $F8, $FB, $FD, $07, $09, $0B, $0F, $15
        
        db $19, $1B, $19, $17, $0D, $0B, $FE, $02
        db $03, $0C, $0C, $0F, $16, $1B, $1B, $FE
        
        db $02, $03, $0C, $0C, $0F, $16, $1B, $1B
        db $FB, $FC, $FD, $FB, $FC, $FD, $18, $19
        
        db $1A, $18, $19, $1A, $0D, $0E, $0F, $0D
        db $0E, $0F, $0D, $0E, $0F, $0D, $0E, $0F
        
        db $FD, $F9, $02, $14, $1A, $18, $0A, $0D
        db $0F, $0A, $0D, $0F, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $F9, $FF, $FE, $FD, $0A, $1A
        
        db $FE, $03, $0E, $FE, $03, $0E, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $FC, $F8, $06, $0F
        
        db $1A, $1A, $0E, $06, $F9, $F9, $16, $1A
        db $10, $08, $05, $0C, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $18, $10, $FB, $10
        
        db $0D, $FC, $FB, $FB, $FF, $FB, $FB, $FB
        db $FB, $0B, $0F, $15, $19, $1B, $0D, $FD
        
        db $F9, $1A, $12, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $FC, $FB, $04, $0E, $14, $0F, $08, $FD
        
        db $F8, $0E, $FD, $0F, $80, $80, $80, $80
        db $80, $80, $80, $09, $05, $FD, $F7, $F5
        
        db $F1, $F7, $FC, $08, $0B, $0E, $14, $19
        db $1B, $1F, $19, $17, $0D, $FE, $FF, $00
        
        db $08, $09, $0C, $10, $18, $1E, $FE, $FF
        db $00, $08, $09, $0C, $10, $18, $1E
    }
    
    ; $69AF2-$69CF0 DATA
    {
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $13, $12, $0E, $0A
        db $00, $FC, $F6, $F3, $F1, $F8, $FA, $FB
        
        db $05, $08, $0C, $12, $16, $17, $03, $FE
        db $F9, $F5, $F2, $F5, $F7, $01, $03, $05
        
        db $0A, $0F, $13, $16, $13, $11, $07, $05
        db $00, $00, $00, $00, $00, $00, $07, $07
        
        db $07, $07, $07, $07, $F6, $F6, $F6, $F6
        db $F6, $F6, $12, $12, $12, $12, $12, $12
        
        db $FD, $02, $FD, $0A, $07, $0A, $F0, $E8
        db $EC, $10, $18, $14, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $FE, $FE, $FE, $0A, $0A, $0A
        
        db $01, $F6, $F5, $07, $12, $13, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $0D, $06, $16, $16
        
        db $08, $FF, $F2, $F2, $FF, $09, $FB, $03
        db $12, $15, $F5, $F4, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $07, $F7, $00, $11
        
        db $16, $0E, $0A, $0A, $0E, $0B, $08, $08
        db $08, $17, $16, $14, $0C, $08, $17, $0E
        
        db $0A, $0C, $0C, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $80, $80, $80, $80, $80, $80, $80, $80
        
        db $80, $80, $80, $80, $80, $80, $80, $80
        db $0D, $0D, $10, $0B, $02, $F5, $F0, $F7
        
        db $00, $0B, $F7, $F5, $80, $80, $80, $80
        db $80, $80, $80, $13, $11, $0F, $0E, $03
        
        db $FF, $FB, $F5, $F2, $F8, $F9, $FA, $03
        db $05, $08, $0C, $12, $16, $03, $FE, $F8
        
        db $F3, $F0, $EC, $F1, $F4, $01, $05, $0A
        db $10, $15, $18, $1C, $17, $14, $07
    }
    
    ; $69CF1-$69EEF DATA
    {
        db $02, $02, $02, $02, $02, $02, $02, $02
        db $02, $0A, $0A, $0A, $0A, $0A, $0A, $0A
        
        db $0A, $0A, $02, $02, $02, $02, $02, $02
        db $02, $02, $02, $02, $02, $02, $02, $02
        
        db $02, $02, $02, $02, $03, $03, $03, $03
        db $03, $03, $03, $03, $01, $00, $00, $00
        
        db $00, $0B, $0B, $0B, $0B, $0B, $02, $02
        db $02, $02, $02, $02, $00, $00, $00, $02
        
        db $02, $02, $02, $02, $02, $00, $00, $00
        db $02, $02, $02, $02, $02, $02, $01, $01
        
        db $01, $01, $01, $01, $00, $00, $00, $00
        db $00, $00, $00, $00, $00, $00, $00, $00
        
        db $03, $03, $03, $06, $06, $06, $05, $05
        db $05, $05, $05, $05, $01, $01, $01, $01
        
        db $01, $01, $01, $01, $01, $01, $02, $03
        db $00, $00, $00, $03, $03, $06, $06, $06
        
        db $00, $00, $00, $00, $00, $00, $02, $02
        db $02, $00, $00, $00, $00, $00, $00, $00
        
        db $00, $00, $00, $03, $03, $03, $02, $00
        db $02, $00, $02, $02, $02, $02, $02, $02
        
        db $0A, $0A, $0A, $0A, $0A, $0A, $02, $02
        db $02, $02, $02, $02, $02, $02, $02, $02
        
        db $02, $02, $03, $03, $03, $03, $01, $01
        db $02, $01, $01, $02, $04, $04, $04, $04
        
        db $04, $04, $03, $03, $03, $03, $03, $03
        db $02, $02, $02, $02, $02, $02, $02, $02
        
        db $02, $02, $02, $02, $04, $04, $04, $04
        db $04, $04, $03, $03, $03, $03, $03, $03
        
        db $02, $02, $02, $02, $02, $02, $02, $02
        db $02, $02, $02, $02, $02, $02, $05, $05
        
        db $05, $05, $05, $05, $02, $02, $05, $05
        db $05, $05, $02, $05, $00, $00, $00, $00
        
        db $00, $00, $00, $00, $00, $00, $00, $00
        db $00, $00, $00, $00, $00, $00, $00, $00
        
        db $07, $07, $07, $07, $08, $08, $08, $08
        db $09, $09, $09, $09, $09, $09, $09, $09
        
        db $00, $00, $00, $07, $07, $07, $07, $07
        db $07, $07, $07, $07, $00, $00, $00, $00
        
        db $00, $00, $00, $00, $00, $00, $00, $00
        db $00, $00, $00, $00, $01, $01, $02, $01
        
        db $01, $01, $01, $01, $01, $03, $03, $0A
        db $0A, $01, $01, $01, $01, $01, $01, $01
        
        db $01, $01, $01, $00, $00, $00, $00, $00
        db $00, $00, $00, $00, $00, $00, $00, $00
        
        db $00, $00, $00, $00, $00, $00, $00, $00
        db $00, $00, $00, $02, $02, $02, $02, $02
        
        db $02, $02, $02, $02, $02, $02, $02, $02
        db $02, $02, $02, $02, $02, $02, $02, $02
        
        db $02, $02, $02, $02, $02, $02, $02, $02
        db $02, $02, $02, $02, $02, $02, $02, $02
        
        db $02, $02, $02, $02, $02, $02, $02, $02
        db $02, $02, $02, $02, $02, $02, $02, $02
        
        db $02, $02, $02, $02, $01, $01, $02, $02
        db $03, $06, $05, $05, $02, $02, $02, $02
        
        db $02, $02, $02, $02, $02, $02, $02, $02
        db $02, $02, $02, $02, $00, $00, $02, $02
        
        db $00, $00, $00, $00, $00, $00, $00, $00
        db $02, $02, $00, $00, $00, $00, $00, $02
        
        db $02, $00, $02, $00, $05, $02, $00, $00
        db $00, $00, $00, $03, $03, $03, $03, $03
        
        db $03, $03, $03, $03, $00, $0B, $0B, $0B
        db $0B, $0B, $0B, $0B, $0B, $02, $02, $02
        
        db $02, $02, $00, $00, $00, $00, $02, $02
        db $02, $02, $02, $00, $00, $00, $00
    }
    
    ; $69EF0-$6A02F DATA
    {
        dw $0000, $0024, $0048, $0060, $006C, $0076, $007A, $0086
        dw $0024, $0092, $009A, $00B2, $00B9, $00BC, $00D4, $00EC
        
        dw $00FC, $0108, $0110, $0120, $012C, $013C, $0153, $016B
        dw $0176, $0186, $018C, $0192, $0198, $01A4, $01A5, $01A6
        
        dw $01A8, $01AC, $01BC, $01C8, $01D4, $01D5, $01D6, $01DB
        dw $0009, $002D, $004E, $0063, $006C, $0077, $007D, $0089
        
        dw $002D, $0094, $00A0, $00B2, $00B9, $00C2, $00DA, $00EC
        dw $00FF, $010A, $0114, $0123, $0130, $013C, $0159, $016B
        
        dw $017A, $0189, $018F, $0192, $019B, $01A4, $01A5, $01A6
        dw $01A9, $01B0, $01BF, $01C8, $01D4, $01D5, $01D6, $01E4
        
        dw $0012, $0036, $0054, $0066, $006C, $0078, $0080, $008C
        dw $0036, $0096, $00A6, $00B2, $00B6, $00C8, $00E0, $00EC
        
        dw $0102, $010C, $0118, $0126, $0134, $013C, $015F, $016B
        dw $017E, $0186, $018C, $0192, $019E, $01A4, $01A5, $01A6
        
        dw $01AA, $01B4, $01C2, $01C8, $01D4, $01D5, $01D6, $01ED
        dw $001B, $003F, $005A, $0069, $006C, $0079, $0083, $008F
        
        dw $003F, $0098, $00AC, $00B2, $00B9, $00CE, $00E6, $00EC
        dw $0105, $010E, $011C, $0129, $0138, $013C, $0165, $016B
        
        dw $0182, $0189, $018F, $0192, $01A1, $01A4, $01A5, $01A6
        dw $01AB, $01B8, $01C5, $01C8, $01D4, $01D5, $01D6, $01F6
    }
    
    ; $6A030-$6A037 DATA
    {
        dw $0000, $0050, $00A0, $00F0
    }
    
    ; $6A038-$6A045 DATA
    {
        dw $0000, $000A, $0016, $0026, $003D, $0048, $0058
    }
    
    ; $6A046-$6A06F DATA (UNUSED?)
    {
        dw $0000, $000D, $001A, $0026, $003D, $004C, $0061
        
        dw $0000, $0010, $001E, $0026, $003D, $0050, $006A
        
        dw $0000, $0013, $0022, $0026, $003D, $0054, $0073
    }
    
    ; $6A070-$6A077 DATA
    {
        dw $0000, $000E, $001C, $002A
    }
    
    ; $6A078-$6A107 DATA
    {
        db $00, $08, $00, $08, $08, $0C, $14, $08
        db $08, $00, $00, $00
    
    ; $6A084
    
        db $04, $0C, $04, $0C, $0C, $10, $18, $0C
        db $0C, $0C, $04, $04
    
    ; $6A090
    
        db $08, $10, $10, $18, $10, $00, $00, $10
        db $18, $10, $18, $10
    
    ; $6A09C
    
        db $14, $1C, $08, $10, $00, $14, $18, $00
        db $10, $04, $10, $1C
    
    ; $6A0A8
    
        db $1C, $00, $1C, $00, $18, $1C, $0C, $1C
        db $24, $1C, $08, $08
    
    ; $6A0B4
        db $28, $28, $28, $28, $28, $28, $28, $28
        db $00, $28, $28, $28
        
    ; $6A0C0
        
        db $14, $1C, $08, $10, $10, $14, $1C, $10
        db $08, $08, $08, $14
    
    ; $6A0CC
    
        db $18, $20, $0C, $14, $14, $18, $20, $14
        db $0C, $14, $0C, $18
        
    ; $6A0D8
    
        db $00, $00, $18, $20, $18, $00, $00, $18
        db $18, $18, $20, $00
    
    ; $6A0E4
    
        db $1C, $24, $10, $18, $08, $1C, $24, $08
        db $10, $0C, $18, $24
    
    ; $60AF0
    
        db $24, $14, $24, $08, $20, $24, $14, $24
        db $24, $24, $10, $1C
    
    ; $6A0FC
    
        db $0C, $0C, $00, $00, $00, $0C, $0C, $00
        db $00, $00, $00, $00
    }

    ; $6A108-$6A11F DATA
    {
        dw $A078, $A0C0
        
    ; $6A10C
    
        dw $A084, $A0CC
    
    ; $6A110 DATA
    {
        dw $A090, $A0D8
    
    ; $6A114
    
        dw $A09C, $A0E4
        
    ; $6A118
        
        dw $A0A8, $A0F0
        
    ; $6A11C
        
        dw $A0B4, $A0FC
    }
    
    ; $6A120-$6A123
    {
        dw $0190, $00E0
    }

    ; $6A126-$6A12D
    {
        dw $2000, $1000, $3000, $2000
    }
    
    ; $6A120-$6A123 DATA
    {
        ; Two possible offsets into OAM buffer for player sprite.
        dw $0190, $00E0
    }
    
    ; $6A124-$6A125 DATA
    {
        ; Another optional offset into the OAM buffer for the player sprite.
        dw $0000
    }

    ; $6A126-$6A12D DATA
    {
        dw $2000, $1000, $3000, $2000
    }
    
    ; $6A12E-$6A130 DATA
    {
        ; Has to do with fire rod and ice rod oam handling...
        db $02, $04, $04
    }
    
    ; $6A131-$6A139 DATA
    {
        db $00, $01, $02, $00, $01, $02, $00, $01, $02
    }

    ; $6A13A-$6A141 DATA
    {
        db $06, $06, $06, $06, $07, $07, $08, $09
    }

    ; $6A142-$6A147 DATA
    {
        db $0C, $0B, $20, $22, $23, $25
    }

    ; $6A148-$6A14F DATA
    {
        ; Methinks the 0x26 belongs to the previous array...?
        db $26, $0B, $0B, $0C, $0B, $0B, $0B, $0D
    }
    
    ; $6A150-$6A15D DATA
    {
        ; Special poses to check for?
        dw $0004, $0010, $0012, $0015, $0017, $0018, $0027
    }

    ; $6A15E
    {
        dw  0, -2, -3,  0, -2, -3
        dw  0,  0,  0,  0,  0,  0
        
    ; $6A176
    
        dw  0, -2, -3,  0, -2, -3
        dw  0,  0,  0,  0,  0,  0
    }
    
; *$6A18E-$6AAC2 LONG
PlayerOam_Main:
{
    ; $72 = 0x00 if not standing in water or grass, 0x02 otherwise
    
    PHB : PHK : PLB
    
    LDY.b #$00
    
    LDA $11 : CMP.b #$12 : BEQ .on_straight_interroom_staircase
    
    LDY.b #$18
    
    ; Checks for submodules 0x12 and 0x13
    CMP.b #$13 : BNE .not_on_straight_interroom_staircase

.on_straight_interroom_staircase

    STY $00
    
    LDA $20 : PHA
    LDA $21 : PHA
    
    LDY.b #$00
    
    LDA $0462 : AND.b #$04 : BEQ .is_straight_up_staircase
    
    LDY.b #$0C

.is_straight_up_staircase

    TYA : ADD $00 : STA $00
    
    ; Link's frame index shouldn't be more than 5 on this kind of staircase.
    LDA $2E : CMP.b #$06 : BCC .frame_index_in_range
    
    LDA.b #$00

.frame_index_in_range

    ASL A : ADD $00 : TAY
    
    REP #$20
    
    ; Ultimately, we have determined an offset to be applied to the player's
    ; Y coordinate, just for the sake of sprite display. The value of the Y
    ; coordinate will be restored near the end of this routine.
    LDA $A15E, Y : ADD $20 : STA $20
    
    SEP #$20

.not_on_straight_interroom_staircase

    ; Assumes this is not submodule 0x12 or 0x13
    
    LDA $20 : SUB $E8 : STA $01
    LDA $22 : SUB $E2 : STA $00
    
    LDA.b #$80 : STA $45 : STA $44
    
    LDX.b #$00
    
    ; Check if we need to draw grass or water around Link (he'd be standing in one of those)
    LDA $0351 : BEQ .not_in_water_or_grass
    
    LDX.b #$01

.not_in_water_or_grass

    ; 0 or 1, eh?...
    TXA : ASL A : STA $72 : STZ $73
    
    REP #$20
    
    LDA $EE : AND.w #$00FF : ASL A : TAX
    
    ; Determine OAM priority from floor level the player is on
    ; (BG2 -> 0x2000, BG1 -> 0x1000, there's two other settings but not clear what they're used for.)
    LDA $A126, X : STA $64
    
    ; Check "sort sprites" setting (HM name)
    LDA $0FB3 : ASL A : TAY
    
    ; "sort sprites" here serves as a selector for where
    ; in the OAM buffer we want to start entering in sprite data for the player. (0x0190 or 0x00E0)
    LDA $A120, Y : STA $0352
    
    SEP #$20
    
    ; Is Link asleep in bed (starting sequence)?
    LDA $5D : CMP.b #$16 : BNE .notInBed
    
    LDY.b #$1F
    
    LDA $037D : CMP.b #$02 : BEQ .notInBed
    
    STA $02
    
    BRL BRANCH_THETA

.notInBed

    LDA $03EF : BEQ .notHoldingUpSword
    
    LDY.b #$24
    
    STZ $02
    
    LDA $2F : STA $0323
    
    BRL BRANCH_THETA

.notHoldingUpSword

    LDA $02E0 : BEQ .not_transforming
    
    LDY.b #$21
    
    LDA $2E : AND.b #$03 : STA $02
    
    LDA $2F : STA $0323
    
    BRL BRANCH_THETA

.not_transforming

    LDY.b #$00
    
    LDA $0351 : BEQ .not_in_water_or_grass_2
    
    LDY.b #$0A

.not_in_water_or_grass_2

    LDA $11 : CMP.b #$0E : BNE BRANCH_MU
    
    ; Is the player dead / dying?
    LDA $10 : CMP.b #$12 : BEQ BRANCH_MU
    
    LDY.b #$0A
    
    LDA $28 : BEQ BRANCH_MU
    
    LDX $2F
    
    CPX.b #$04 : BEQ .facing_left_or_right
    CPX.b #$06 : BEQ .facing_left_or_right
    
    LDX $2E
    
    LDA $A131, X : STA $02
    
    LDY.b #$19
    
    LDA $0462 : AND.b #$04 : BEQ .is_up_spiral_staircase
    
    LDY.b #$1A
    
    BRA BRANCH_XI

BRANCH_MU:

    LDA $0376 : AND.b #$03 : BEQ .notGrabbingWall
    
    LDY.b #$18
    
    LDA $030A : STA $02
    
    BRA BRANCH_XI

.notGrabbingWall

    LDA $48 : AND.b #$0D : BEQ .not_feeling_grabby
    
    LDY.b #$16
    
    LDA $2E : CMP.b #$05 : BCC .not_feeling_grabby
    
    STZ $2E

.not_feeling_grabby
.facing_left_or_right

    LDA $2E : STA $02

.is_up_spiral_staircase
BRANCH_XI:

    LDA $2F : STA $0323
    
    LDA $0345 : BEQ .not_in_deep_water
    
    ; Force to priority level 2 if we're in deep water.
    LDA.b #$20 : STA $65 : STZ $64

.not_in_deep_water

    LDA $5D : CMP.b #$04 : BNE .not_swimming
    
    LDY.b #$11
    
    LDA $02 : AND.b #$01 : STA $02
    
    LDA $11 : BNE BRANCH_RHO
    
    ; Check previous button presses
    LDA $F0 : AND.b #$0F : BNE BRANCH_SIGMA

BRANCH_RHO:

    LDA $033C : ORA $033D : ORA $033E : ORA $033F : BEQ BRANCH_TAU

BRANCH_SIGMA:

    LDY.b #$13
    
    LDA $02CC : STA $02

BRANCH_TAU:

    LDA $032A : BEQ BRANCH_UPSILON
    
    DEC A : STA $02
    
    LDY.b #$12

BRANCH_UPSILON:

    BRL BRANCH_THETA

.not_swimming

    LDA $02DA : BEQ .not_in_hold_item_pose
    
    STZ $02
    
    LDY.b #$1E
    
    CMP.b #$02 : BEQ .two_hand_hold_item_pose
    
    LDY.b #$1D

.two_hand_hold_item_pose

    BRA BRANCH_UPSILON

.not_in_hold_item_pose

    ; Has something to do with the death module. Perhaps the player sprite
    ; lying down?
    LDA $036B : AND.b #$01 : BEQ BRANCH_OMEGA
    
    LDA $030A : STA $02
    
    LDY.b #$1B
    
    BRA BRANCH_UPSILON

BRANCH_OMEGA:

    LDA $4D    : BEQ BRANCH_ALTIMA
    CMP.b #$01 : BEQ BRANCH_ULTIMA
    CMP.b #$04 : BNE BRANCH_ALTIMA
    
    LDY.b #$13
    
    LDA $1A : AND.b #$18 : LSR #3 : TAX
    
    LDA $079635, X : STA $02
    
    BRL BRANCH_THETA

BRANCH_ULTIMA:

    LDA $5D : CMP.b #$05 : BNE .notOnSomariaPlatform
    
    LDA $034E : BNE BRANCH_ALIF
    
    LDA.b #$30 : STA $65 : STZ $64

BRANCH_ALIF:

    BRL BRANCH_BET

.notOnSomariaPlatform

    ; Is the player using the hookshot?
    LDA $5D : CMP.b #$13 : BEQ BRANCH_ALTIMA
    
    LDA $55 : BNE BRANCH_ALTIMA
    
    LDY.b #$05
    
    LDA $0360 : BEQ BRANCH_DEL
    
    LDY.b #$14
    
    LDA $0300 : AND.b #$03

BRANCH_DEL:

    STA $02
    
    BRL BRANCH_THETA

BRANCH_ALTIMA:

    LDA $5B    : BEQ BRANCH_THEL
    CMP.B #$01 : BEQ BRANCH_THEL
    CMP.b #$03 : BNE BRANCH_SIN
    
    ; Use an offset of 0x0000 in the OAM buffer when the player is falling
    ; into a hole or to the floor below?
    LDA $A124 : STA $0352
    LDA $A125 : STA $0353

BRANCH_SIN: 

    LDA $5A : STA $02 : CMP.b #$06 : BCC BRANCH_SHIN
    
    LDA $65 : ORA.b #$30 : STA $65

BRANCH_SHIN:

    LDY.b #$04
    
    BRL BRANCH_THETA

BRANCH_THEL:

    LDA $0308 : BEQ .not_carrying_something
    
    JSR PlayerOam_GetHighestSetBit
    
    ; This comparison would seem to indicate that some other part of the code
    ; gives a damn about bit 6 of this variable, but in truth the only relevant
    ; bits are 0 and 7. They could have just used a BMI instruction.
    CPX.b #$06 : BCS BRANCH_SOD
    
    ; Force player to face down...? Why?
    LDA.b #$02 : STA $0323

BRANCH_SOD:

    LDY $A148, X : CPY.b #$0D : BCC BRANCH_DOD
    
    LDA $0309 : AND.b #$02 : BEQ BRANCH_TOD
    
    INY

BRANCH_TOD:

    LDA $0309 : AND.b #$01 : BEQ BRANCH_ZOD
    
    LDY.b #$10
    
    BRA BRANCH_DOD

BRANCH_ZOD:

    LDA $0308 : AND.b #$80 : BEQ BRANCH_DOD
    
    BRL BRANCH_THETA

BRANCH_DOD:

    LDA $030A
    
    BRA BRANCH_FATHA

.not_carrying_something
BRANCH_BET:

    LDA $0377 : BEQ BRANCH_ZAH
    
    DEC A
    
    LDY.b #$17
    
    BRA BRANCH_FATHA

BRANCH_ZAH:

    LDA $0301 : BEQ BRANCH_YEH
    
    JSR PlayerOam_GetHighestSetBit
    
    LDY $A13A, X
    
    BRA BRANCH_HEH

BRANCH_YEH:

    LDA $037A : BEQ BRANCH_JIIM
    
    JSR PlayerOam_GetHighestSetBit
    
    LDY $A142, X

BRANCH_HEH:

    LDA $0300

BRANCH_FATHA:

    STA $02
    
    BRA BRANCH_THETA

BRANCH_JIIM:

    LDA $5D : CMP.b #$0A : BEQ BRANCH_HAMZA
              CMP.b #$08 : BEQ BRANCH_HAMZA
              CMP.b #$09 : BNE BRANCH_ARIES

BRANCH_HAMZA:

    LDY.b #$15
    
    BRA BRANCH_LEO

BRANCH_ARIES:

    CMP.b #$1E : BEQ BRANCH_SAGITTARIUS
    CMP.b #$03 : BNE BRANCH_TAURUS

BRANCH_SAGITTARIUS:

    LDY.b #$0F

BRANCH_LEO:

    LDA $031C : STA $02
    
    BRA BRANCH_THETA

BRANCH_TAURUS:

    ; Check B button status
    ; B button not down
    LDA $3A : AND.b #$80 : BEQ BRANCH_THETA
    
    ; Check how long the B button has been pressed
    ; Not nine frames
    LDA $3C : CMP.b #$09 : BNE BRANCH_VIRGO
    
    LDY.b #$02
    
    BRA BRANCH_THETA

BRANCH_VIRGO:

    LDY.b #$27
    
    ; B button has been pressed less than 9 frames
    LDA $3C : STA $02 : CMP.b #$09 : BCC BRANCH_THETA
    
    LDA $02 : SUB.b #$0A : STA $02
    
    LDY.b #$03

BRANCH_THETA:

    STY $0354 : CPY.b #$05 : BEQ BRANCH_KESRA
    
    LDA $64 : STA $035D
    LDA $65 : STA $035E

BRANCH_KESRA:

    STZ $03
    
    LDA $02 : STA $76
    
    REP #$30
    
    LDA $2F : AND.w #$00FF : TAX
    
    LDA $A070, X : STA $74
    LDA $A030, X : STA $04 ; Multiples of 0x50...
    
    ; I think Y is the "pose" for the particular direction we're facing.
    TYA : AND.w #$00FF : ASL A : ADD $04 : TAY
    
    ; $02 is probably a subpose index...
    LDA $9EF0, Y : ADD $02 : STA $02 : TAY
    
    LDA $9CF1, Y : AND.w #$00FF : STA $04
    
    LDA.w #$0E00 : STA $0346
    
    LDA $0ABD : BEQ .not_alternate_palette
    
    ; Use palette SP0 instead of SP7
    STZ $0346

.not_alternate_palette

    STZ $0102
    STZ $0104
    
    LDX.w #$000C

BRANCH_GHEIN:

    LDA $0354 : AND.w #$00FF : CMP $A150, X : BEQ BRANCH_EIN
    
    DEX #2 : BPL BRANCH_GHEIN
    
    BRL BRANCH_RAH

BRANCH_EIN:

    TXA : AND.w #$00FF : ADD $74 : TAX
    
    LDA $76 : AND.w #$00FF : ADD $A038, X : STA $74
    
    LDY $74
    
    LDA $89F9, Y : AND.w #$00FF : CMP.w #$00FF : BNE BRANCH_CAPRICORN
    
    BRL BRANCH_GEMINI

BRANCH_CAPRICORN:

    ASL A : STA $0102
    
    LDX $72
    
    LDA $A108, X : STA $0A
    
    LDY $04
    
    LDA ($0A), Y : AND.w #$00FF : ADD $0352 : TAX
    
    LDY $74
    
    SEP #$20
    
    LDA $25 : BMI BRANCH_LIBRA
    
    LDA $24
    
    BRA BRANCH_AQUARIUS

BRANCH_LIBRA:

    LDA $24 : CMP.b #$F0 : BCC BRANCH_AQUARIUS
    
    LDA.b #$00

BRANCH_AQUARIUS:

    STA $0F : STZ $0E
    
    LDA $92ED, Y : ADD $01 : SUB $0F : STA $0801, X
    LDA $9369, Y : ADD $00 :            STA $0800, X
    
    REP #$20
    
    LDA $89F9, Y : AND.w #$00FF : STA $06
    
    LSR A : TAY
    
    LDA $838C, Y : TAY
    
    LDA $06 : AND.w #$0001 : BEQ BRANCH_CANCER
    
    TYA : ASL #4 : TAY

BRANCH_CANCER:

    TYA : AND.w #$C000 : ORA $64 : ORA $0346 : ORA.w #$0004 : STA $0802, X
    
    TXA : LSR #2 : TAX
    
    LDA $0A20, X : AND.w #$FF00 : STA $0A20, X

BRANCH_GEMINI:

    LDY $74
    
    LDA $8A75, Y : AND.w #$00FF : CMP.w #$00FF : BNE BRANCH_SCOPRIO
    
    BRL BRANCH_RAH

BRANCH_SCOPRIO:

    ASL A : STA $0104
    
    LDX $72
    
    LDA $A10C, X : STA $0A
    
    LDY $04
    
    LDA ($0A), Y : AND.w #$00FF : ADD $0352 : TAX
    
    LDY $74
    
    SEP #$20
    
    LDA $25 : BMI BRANCH_PISCES
    
    LDA $24
    
    BRA BRANCH_CLOUD

BRANCH_PISCES:

    LDA $24 : CMP.w #$F0 : BCC BRANCH_CLOUD
    
    LDA.w #$00

BRANCH_CLOUD:

    STA $0F : STZ $0E
    
    LDA $93E5, Y : ADD $01 : SUB $0F : STA $0801, X
    
    LDA $9461, Y : ADD $00 : STA $0800, X
    
    REP #$20
    
    LDA $8A75, Y : AND.w #$00FF : STA $06
    
    LSR A : TAY
    
    LDA $838C, Y : TAY
    
    LDA $06 : AND.w #$0001 : BEQ BRANCH_SEPHIROTH
    
    TYA : ASL #4 : TAY

BRANCH_SEPHIROTH:

    TYA : AND.w #$C000 : ORA $64 : ORA $0346 : ORA.w #$0014 : STA $0802, X
    
    TXA : LSR #2 : TAX
    
    LDA $0A20, X : AND.w #$FF00 : STA $0A20, X

BRANCH_RAH:

    LDA $0309 : AND.w #$0004 : BEQ BRANCH_LINK
    
    JSR $ADB6 ; $6ADB6 IN ROM
    
    BRA BRANCH_GANON

BRANCH_LINK:

    LDA $5D : AND.w #$00FF
    
    CMP.w #$0008 : BEQ .is_spinning_mode
    CMP.w #$0009 : BEQ .is_spinning_mode
    CMP.w #$000A : BEQ .is_spinning_mode
    CMP.w #$0003 : BEQ .is_spinning_mode
    CMP.w #$001E : BEQ .is_spinning_mode
    
    LDA $0308 : AND.w #$00FF : BNE .holding_hands_up
    
    LDA $03EF : ORA $0360 : AND.w #$00FF : BNE .holding_hands_up
    
    LDA $0301 : AND.w #$0040 : BNE BRANCH_GANON
    
    LDA $037A : AND.w #$003D : BNE BRANCH_MERCURY
    
    LDA $0301 : AND.w #$0093 : BNE BRANCH_MERCURY
    
    LDA $3A : AND.w #$0080 : BEQ BRANCH_GANON

.is_spinning_mode
.holding_hands_up

    LDA $7EF359 : INC A : AND.w #$00FE : BEQ BRANCH_GANON

BRANCH_MERCURY:

    ; $6AB6E IN ROM
    JSR $AB6E : BCC BRANCH_VENUS

BRANCH_GANON:

    BRL BRANCH_MARIO

BRANCH_VENUS:

    LDY $02
    
    SEP #$20
    
    LDA $25 : BMI BRANCH_EARTH
    
    LDA $24
    
    BRA BRANCH_MARS

BRANCH_EARTH:

    LDA $24 : CMP.b #$F0 : BCC BRANCH_MARS
    
    LDA.b #$00

BRANCH_MARS:

    STA $0B
    
    LDA $01 : ADD $8EEF, Y : SUB $0B : STA $0B
    
    LDA $00 : ADD $90EE, Y : STA $0A : STA $08
    
    LDA $0301 : AND.b #$02 : BEQ BRANCH_JUPITER
    
    LDA $0300 : CMP.b #$02 : BNE BRANCH_SATURN
    
    LDA $3D : CMP.b #$0F : BNE BRANCH_SATURN
    
    BRA BRANCH_URANUS

BRANCH_JUPITER:

    LDA $0301 : AND.b #$05 : BNE BRANCH_SATURN

BRANCH_URANUS:

    LDA $98F3, Y : STA $44
    LDA $9AF2, Y : STA $45

BRANCH_SATURN:

    STZ $0E
    STZ $0F
    
    LDA $0301 : AND.b #$05 : BEQ BRANCH_NEPTUNE
    
    LDY $0307 : DEY
    
    LDA $A12E, Y : STA $0F

BRANCH_NEPTUNE:

    LDA $037A : AND.b #$08 : BEQ BRANCH_PLUTO
    
    LDA $0303 : CMP.b #$0D : BNE BRANCH_PLUTO
    
    LDA.b #$04 : STA $0F

BRANCH_PLUTO:

    REP #$20
    
    LDA $06 : ASL A : ADD $06 : ASL A : TAY
    
    STZ $06
    
    PHY
    
    LDX $72
    
    LDA $A110, X : STA $74
    
    LDA $04 : AND.w #$00FF : TAY
    
    LDA ($74), Y : AND.w #$00FF : ADD $0352 : TAX
    
    PLY
    
    LDA $0E : PHA
    
    JSR $ACD5 ; $6ACD5 IN ROM
    
    PLA : STA $0E

BRANCH_DUEY:

    REP #$20
    
    LDA $839B, Y : CMP.w #$FFFF : BEQ BRANCH_MICKEY
    
    AND.w #$CFFF : ORA $64 : STA $0802, X
    
    AND.w #$0E00 : CMP.w #$0200 : BEQ BRANCH_MINNIE
    
    LDA $0346 : BNE BRANCH_MINNIE
    
    LDA $0802, X : AND.w #$F1FF : ORA.w #$0600 : STA $0802, X

BRANCH_MINNIE:

    LDA $0E : BEQ BRANCH_DONALD
    
    LDA $0802, X : AND.w #$F1FF : ORA $0E : STA $0802, X

BRANCH_DONALD:

    LDA $0A : STA $0800, X
    
    AND.w #$00FF : STA $74
    
    LDA $00 : AND.w #$00FF : SUB $74 : BPL BRANCH_GOOFY
    
    EOR.w #$FFFF : INC A

BRANCH_GOOFY:

    CMP.w #$0080 : BCC BRANCH_CHIP
    
    LDA.w #$0001 : TSB $0C

BRANCH_CHIP:

    PHY : PHX
    
    TXA : LSR #2 : TAX
    
    SEP #$20
    
    LDA $0C : STA $0A20, X
    
    AND.b #$FE : STA $0C
    
    PLX : PLY
    
    INX #4

BRANCH_MICKEY:

    SEP #$20
    
    LDA $0A : ADD.b #$08 : STA $0A
    
    INY #2
    
    LDA $06 : INC A : STA $06 : AND.b #$01 : BNE BRANCH_DALE
    
    LDA $0B : ADD.b #$08 : STA $0B
    
    LDA $08 : STA $0A

BRANCH_DALE:

    LDA $06 : CMP.b #$03 : BEQ BRANCH_HUEY
    
    BRL BRANCH_DUEY

BRANCH_HUEY:

    SEP #$10

BRANCH_MARIO:

    REP #$30
    
    ; Shield
    LDA $7EF35A : AND.w #$00FF : BEQ .dontShowShield
    
    ; Check out progress indicator to see if Link's gotten the shield from his uncle yet.
    ; In other words, if Link has entered phase 1
    LDA $7EF3C5 : AND.w #$00FF : BEQ .dontShowShield
    
    ; $6ABE6 IN ROM; affects graphics when carrying things?
    JSR $ABE6 : BCC .showShield

.dontShowShield

    BRL BRANCH_FLINTHEART

; Pretty sure this label is accurate, would require in game tesing
.showShield

    LDY $02
    
    SEP #$20
    
    LDA $25 : BMI BRANCH_GIZMO
    
    LDA $24
    
    BRA BRANCH_TERRA

BRANCH_GIZMO:

    LDA $24 : CMP.b #$F0 : BCC BRANCH_TERRA
    
    LDA.b #$00

BRANCH_TERRA:

    STA $0B
    
    LDA $01 : ADD $94DD, Y : DEC A : SUB $0B : STA $0B
    
    LDA $00 : ADD $96DC, Y : STA $0A : STA $08
    
    LDA $96DC, Y
    
    JSR PlayerOam_GetRelativeHighBit
    
    STZ $0E
    
    LDA.b #$0A : STA $0F
    
    ; Branch if the player sprite is using palette 7, which is typical.
    LDA $0347 : BNE .not_alternate_palette_2
    
    LDA.b #$06 : STA $0F

.not_alternate_palette_2

    REP #$30
    
    LDA $06 : ASL A : ADD $06 : ASL A : TAY
    
    STZ $06
    
    PHY
    
    LDX $72
    
    LDA $A118, X : STA $74
    
    LDA $04 : AND.w #$00FF : TAY
    
    LDA ($74), Y : AND.w #$00FF : ADD $0352 : TAX
    
    PLY

BRANCH_LOCKE:

    REP #$20
    
    STZ $74
    
    LDA $8563, Y : CMP.w #$FFFF : BEQ BRANCH_SABIN
    
    AND.w #$C1FF : ORA $0E : ORA $64 : STA $0802, X
    
    LDA $0A : STA $0800, X
    
    PHX
    
    TXA : LSR #2 : TAX
    
    SEP #$20
    
    ; Or in the 9th bit of the X coordinate
    LDA $0C : ORA $03FA : STA $0A20, X
    
    PLX : INX #4

BRANCH_SABIN:

    SEP #$20
    
    LDA $0A : ADD.b #$08 : STA $0A
    
    INY #2
    
    INC $06
    
    LDA $06 : AND.b #$01 : BNE BRANCH_EDGAR
    
    LDA $0B : ADD.b #$08 : STA $0B
    
    LDA $08 : STA $0A

BRANCH_EDGAR:

    LDA $06 : CMP.b #$03 : BNE BRANCH_LOCKE
    
    SEP #$10

BRANCH_FLINTHEART:

    SEP #$30
    
    LDA $4B : CMP.b #$0C : BNE .player_is_visible
    
    BRL BRANCH_MOG

.player_is_visible

    LDA $5D : CMP.b #$16 : BEQ BRANCH_UMARO
    
    LDA $0354 : CMP.b #$05 : BEQ BRANCH_GOGO
    
    ; See if Link is standing in water.
    LDA $0351 : BEQ BRANCH_GOGO
    
    JSR $AED1 ; $6AED1 IN ROM; Draws water/grass sprites around Link
    
    BRA BRANCH_UMARO

BRANCH_GOGO:

    LDA $4D : CMP.b #$04 : BEQ BRANCH_UMARO
    
    LDA $5D : CMP.b #$04 : BEQ BRANCH_UMARO
    
    LDY.b #$00
    
    LDA $5B    : BEQ BRANCH_DARYL
    CMP.b #$01 : BEQ BRANCH_DARYL
    
    LDA $5A : CMP.b #$06 : BCC BRANCH_UMARO
    
    JSR $AE3B ; $6AE3B IN ROM

BRANCH_UMARO:

    BRL BRANCH_MOG

BRANCH_DARYL:

    LDA $4D    : BEQ BRANCH_ADLAI
    CMP.b #$01 : BNE BRANCH_SHADOW
    
    LDA $55 : BNE BRANCH_ADLAI

BRANCH_SHADOW:

    LDY.b #$01

BRANCH_ADLAI:

    STY $0A
    STZ $0B
    
    LDA $0323 : LSR A : TAY
    
    REP #$20
    
    LDA $20 : SUB $E8 : STA $06
    
    LDA $98DB, Y : AND.w #$00FF : CMP.w #$0080 : BCC BRANCH_CYAN
    
    ORA.w #$FF00

BRANCH_CYAN:

    ADD $06 : STA $06
    
    SEP #$20
    
    LDA $07 : BNE BRANCH_UMARO
    
    LDA $01 : ADD $98DB, Y : STA $07
    LDA $00 : ADD $98E7, Y : STA $06
    
    REP #$30
    
    LDX $72
    
    LDA $A11C, X : STA $74
    
    LDA $04 : AND.w #$00FF : TAY
    
    LDA ($74), Y : AND.w #$00FF : ADD $0352 : TAX
    
    LDA $0A : ASL #2 : TAY
    
    LDA $85CF, Y : AND.w #$CFFF : ORA $035D : STA $0802, X
    
    AND.w #$3FFF : ORA.w #$4000 : STA $0806, X
    
    LDA $06 : STA $0800, X
    
    XBA : ADD.w #$0800 : XBA : STA $0804, X
    
    LDA $0346 : BNE BRANCH_MAGENTA
    
    LDA $0802, X : AND.w #$F1FF : ORA.w #$0600 : STA $0802, X
    
    LDA $0806, X : AND.w #$F1FF : ORA.w #$0600 : STA $0806, X

BRANCH_MAGENTA:

    TXA : LSR #2 : TAX
    
    STZ $0A20, X
    
    SEP #$30

BRANCH_MOG:

    REP #$30
    
    LDX $72
    
    LDA $A114, X : STA $74
    
    LDY $04
    
    ; Determine the finalized offset into the OAM buffer?
    LDA ($74), Y : AND.w #$00FF : ADD $0352 : TAX
    
    LDA $02 : ASL A : TAY
    
    LDA $85FB, Y : STA $0E
    
    ASL A : STA $0100
    
    ADD $0E : TAY
    
    SEP #$20
    
    LDA $4B : CMP.b #$0C : BNE BRANCH_RELM
    
    BRL BRANCH_STRAGO

BRANCH_RELM:

    LDA $25 : BMI BRANCH_KEFKA
    
    LDA $24
    
    BRA BRANCH_MEGAMAN

BRANCH_KEFKA:

    LDA $24 : CMP.b #$F0 : BCC BRANCH_MEGAMAN
    
    LDA.b #$00

BRANCH_MEGAMAN:

    STA $0F
    STZ $0E
    
    LDA $01 : ADD $8000, Y : SUB $0F : STA $0B
    LDA $00 : ADD $8001, Y            : STA $0A
    
    REP #$20
    
    LDA $8002, Y : XBA : STA $06
    
    AND.w #$F000 : CMP.w #$F000 : BEQ BRANCH_CRONO
    
    ORA $64 : ORA $0346 : STA $0802, X
    
    STZ $02
    
    LDA $0A : STA $0800, X
    
    AND.w #$00FF : CMP.w #$00F8 : BCC BRANCH_MARLE
    
    LDA.w #$0001 : STA $02

BRANCH_MARLE:

    PHX
    
    TXA : LSR #2 : TAX
    
    LDA $0A20, X : AND.w #$FF00 : ORA $02 : ORA.w #$0002 : STA $0A20, X
    
    PLX

BRANCH_CRONO:

    LDA $06 : AND.w #$0F00 : CMP.w #$0F00 : BEQ BRANCH_STRAGO
    
    ASL #4 : ORA $64 : ORA $0346 : ORA.w #$0002 : STA $0806, X
    
    LDA $00 : SUB $0E : ADD.w #$0800 : STA $0804, X
    
    TXA : LSR #2 : TAX
    
    LDA $0A21, X : AND.w #$FF00 : ORA.w #$0002 : STA $0A21, X

BRANCH_STRAGO:

    SEP #$30
    
    LDA.b #$01 : STA $0E
    
    LDA $6C : BEQ .not_in_doorway
    
    REP #$20
    
    LDA $22 : SUB $E2
    
    CMP.w #$0004 : BCC BRANCH_LUCCA
    CMP.w #$00FC : BCS BRANCH_LUCCA
    
    LDA $20 : SUB $E8
    
    CMP.w #$0004 : BCC BRANCH_LUCCA
    CMP.w #$00E0 : BCS BRANCH_LUCCA
    
    SEP #$20

.not_in_doorway

    STZ $0E
    
    LDA $11 : BNE BRANCH_GUARDIA
    
    LDA $031F : BEQ BRANCH_GUARDIA
    
    DEC A : STA $031F
    
    CMP.b #$04 : BCC BRANCH_GUARDIA
    AND.b #$01 : BEQ BRANCH_LUCCA

BRANCH_GUARDIA:

    LDA $4B : CMP.b #$0C : BEQ BRANCH_LUCCA
    
    LDA $55 : BEQ .cape_inactive_z

BRANCH_LUCCA:

    REP #$30
    
    LDA $0352 : LSR #2 : TAX
    
    LDA.w #$0101 : STA $0A20, X : STA $0A22, X : STA $0A24, X
                   STA $0A26, X : STA $0A28, X : STA $0A2A, X
    
    LDA $4B : AND.w #$00FF : CMP.w #$000C : BEQ BRANCH_FROG
    
    LDA $0E : AND.w #$00FF : BNE BRANCH_FROG
    
    LDX $72
    
    LDA $A11C, X : STA $74
    
    LDA $04 : AND.w #$00FF : TAY
    
    LDA ($74), Y : AND.w #$00FF : ADD $0352 : LSR #2 : TAX
    
    STZ $0A20, X

BRANCH_FROG:

    SEP #$30

.cape_inactive_z

    LDA $11
    
    ; z is a placeholder until we figure out how many there are like this.
    CMP.b #$12 : BEQ .on_straight_interroom_staircase_z
    CMP.b #$13 : BNE .not_on_straight_interroom_staircase_z

.on_straight_interroom_staircase_z

    PLA : STA $21
    PLA : STA $20

.not_on_straight_interroom_staircase_z

    PLB
    
    RTL
}

; ==============================================================================

    ; *$6AAC3-$6AACB LOCAL
    PlayerOam_GetHighestSetBit:
    {
        ; This routine returns the highest bit set in whatever variable is the
        ; accumulator. Note: you wouldn't want to call this with a 16-bit
        ; accumulator enabled.
        
        LDX.b #$07
    
    .next_bit:
    
        ASL A : BCS .bit_was_set
        
        DEX : BPL .next_bit
    
    .bit_was_set
    
        RTS
    }

; ==============================================================================

    ; $6AACC-$???? DATA
    {
        
    
    ; $6AB22
    
        
    }
    
    ; *$6AB6E-$6ABC9 LOCAL
    {
        REP #$30
        
        LDY $02
        
        LDA $8AF1, Y : AND.w #$00FF : CMP.w #$00FF : BEQ BRANCH_ALPHA
        
        STA $06 : TAX
        
        LDA $AB22, X : AND.w #$00FF : STA $0C
        
        TXA
        
        LDY $AACC, X : CMP.w #$001D : BCC BRANCH_BETA
        
        LDA $0301 : AND.w #$0005 : BEQ BRANCH_GAMMA
        
        TXA : SUB #$001D : TAX
        
        LDY $AB18, X
    
    BRANCH_GAMMA:
    
        TYA : AND.w #$00FF : STA $0A
        
        LDA $0109 : AND.w #$FF00 : ORA $0A : STA $0109
        
        BRA BRANCH_DELTA
    
    BRANCH_BETA:
    
        TYA : AND.w #$00FF : STA $0A
        
        LDA $0107 : AND.w #$FF00 : ORA $0A : STA $0107
    
    BRANCH_DELTA:
    
        CLC
        
        RTS
    
    BRANCH_ALPHA:
    
        SEC
        
        RTS
    }

    ; $6ABCA-$6ABCD? DATA
    {
        db $00, $02, $04, $04
    }
    
    ; $6
    
    
    ; *$6ABE6-$6AC44 LOCAL
    {
        REP #$30
        
        STZ $0C
        
        LDY $02
        
        ; Appears to only range from 0xFF to 0x03
        LDA $8CF0, Y : AND.w #$00FF : CMP.w #$00FF : BEQ BRANCH_ALPHA
        
        STA $06 : TAX : LDY $ABCA, X : AND.w #$00F8 : BEQ BRANCH_BETA
        
        LDA $0301 : AND.w #$0005 : BEQ BRANCH_GAMMA
        
        TXA : SUB.w #$0008 : TAX
        
        LDY $ABDC, X
    
    BRANCH_GAMMA:
    
        TYA       : AND.w #$00FF : STA $0A
        LDA $0109 : AND.w #$FF00 : ORA $0A : STA $0109
        
        AND.w #$0007 : BEQ BRANCH_DELTA
        
        BRA BRANCH_EPSILON
    
    BRANCH_BETA:
    
        TYA : AND.w #$00FF : STA $0A
        
        LDA $0108 : AND.w #$FF00 : ORA $0A : STA $0108
    
    BRANCH_DELTA:
    
        LDA.w #$0002 : STA $0C
    
    BRANCH_EPSILON:
    
        CLC
        
        RTS
    
    BRANCH_ALPHA:
    
        SEC
        
        RTS
    }

    ; *$6ACD5-$6AD81 LOCAL
    {
        LDA $0A : PHA
        
        PHY
        
        LDA $5D : BEQ BRANCH_ALPHA
    
    BRANCH_GAMMA:
    
        BRL BRANCH_BETA
    
    BRANCH_ALPHA:
    
        LDA $7EF359
        
        AND.w #$00FF : BEQ BRANCH_GAMMA
        CMP.w #$00FF : BEQ BRANCH_GAMMA
        CMP.w #$0001 : BEQ BRANCH_GAMMA
        
        LDA $3A : AND.w #$0080 : BEQ BRANCH_GAMMA
        
        LDA $3C : AND.w #$00FF : CMP.w #$0009 : BCS BRANCH_GAMMA
        
        ASL A : STA $0A
        
        LDA $2F : AND.w #$00FF : LSR A : STA $0E
        
        ASL #3 : ADD $0E : ASL A : ADD $0A : TAY
        
        LDA $AC45, Y : CMP.w #$FFFF : BEQ BRANCH_BETA
        
        AND.w #$CFFF : ORA $64 : STA $0802, X
        
        LDA $0346 : BNE BRANCH_DELTA
        
        LDA $0802, X : AND.w #$F1FF : ORA.w #$0600 : STA $0802, X
    
    BRANCH_DELTA:
    
        TYA : LSR A : TAY
        
        SEP #$20
        
        LDA $AC8D, Y : ADD $01 : STA $0B
        LDA $ACB1, Y : ADD $00 : STA $0A
        
        LDA $AC8D, Y : STA $44
        LDA $ACB1, Y : STA $45
        
        JSR PlayerOam_GetRelativeHighBit
        
        REP #$20
        
        LDA $0A : STA $0800, X
        
        INX #4
        
        PHX
        
        TXA : SUB.w #$0004 : LSR #2 : TAX
        
        ; Or in the 9th bit of the X coordinate
        LDA.w #$0000 : ORA $03FA : STA $0A20, X
        
        PLX
    
    BRANCH_BETA:
    
        STZ $0E
        
        PLY
        
        PLA : STA $0A
        
        RTS
    }

    ; *$6ADB6-$6AE37 LOCAL
    {
        SEP #$30
        
        LSR #2
        
        JSR PlayerOam_GetHighestSetBit
        
        LDA $ADB4, X : ADD $030E : ASL #2 : STA $06 : STZ $07
        
        LDA.b #$42 : STA $0109
        
        REP #$30
        
        LDX $72
        
        LDA $A110, X : STA $74
        
        LDA $04 : AND.w #$00FF : TAY
        
        LDA ($74), Y : AND.w #$00FF : ADD $0352 : TAX
        
        LDY $06
        
        STZ $06
    
    BRANCH_BETA:
    
        SEP #$20
        
        LDA $01 : ADD $AD94, Y : STA $0B
        LDA $00 : ADD $ADA4, Y : STA $0A
        
        PHY
        
        LDA $AD84, Y : CMP.b #$FF : BEQ BRANCH_ALPHA
        
        REP #$20
        
        AND.w #$00FF : TAY
        
        LDA $AD82, Y : AND.w #$CFFF : ORA $64 : STA $0802, X
        
        LDA $0A : STA $0800, X
        
        PHX
        
        TXA : LSR #2 : TAX
        
        SEP #$20
        
        STZ $0A20, X
        
        PLX : INX #4
    
    BRANCH_ALPHA:
    
        PLY : INY
        
        INC $06 : LDA $06 : CMP.b #$04 : BNE BRANCH_BETA
        
        LDA $06 : CMP.b #$04 : BNE BRANCH_BETA
        
        REP #$30
        
        RTS
    }

; ==============================================================================

    ; $6AE38-$6AE3A DATA
    {
    
    ; \task Name this routine / pool.
    .unknown_0
        db $00, $00, $04
    }

; ==============================================================================

    ; *$6AE3B-$6AEC9 LOCAL
    {
        LDY.b #$00
        
        LDA $51 : SUB.b #$0C : SUB $20
        
        CMP.b #$F0 : BCS BRANCH_ALPHA
        CMP.b #$30 : BCC BRANCH_BETA
        
        LDY.b #$04
    
    BRANCH_BETA:
    
        CMP.b #$60 : BCC BRANCH_ALPHA
        
        LDY.b #$08
    
    BRANCH_ALPHA:
    
        TYA : LSR A : LSR A : TAX
        
        LDA .unknown_0, X : STA $06
        
        LDA $51 : SUB.b #$0C : SUB $E8 : ADD.b #$1D : STA $07
        
        LDA $00 : ADD $06 : STA $06
        
        STZ $04
        
        REP #$30
        
        PHY
        
        LDX $72
        
        LDA $A11C, X : STA $74
        
        LDA $03 : AND.w #$00FF : TAY
        
        LDA ($74), Y : AND.w #$00FF : ADD $0352 : TAX
        
        PLY
    
    BRANCH_DELTA:
    
        REP #$20
        
        LDA $85CF, Y : CMP.w #$FFFF : BEQ BRANCH_GAMMA
        
        AND.w #$CFFF : ORA $035D : STA $0802, X
        
        LDA $06 : STA $0800, X
    
    BRANCH_GAMMA:
    
        PHX
        
        TXA : LSR #2 : TAX
        
        SEP #$20
        
        STZ $0A20, X
        
        PLX
        
        LDA $06 : ADD.b #$08 : STA $06
        
        INY #2
        
        INX #4
        
        INC $04
        
        LDA $04 : CMP.b #$02 : BNE BRANCH_DELTA
        
        SEP #$10
        
        RTS
    }

; ==============================================================================

    ; $6AECA-$6AED0 DATA
    {
    
    ; \task Name this pool / routine.
    .unknown_0
        db $0A, $02, $0E, $04, $04, $08, $08
    }

; ==============================================================================

    ; *$6AED1-$6AF9C LOCAL
    {
        ; Seems to draw the ripples around Link while standing in shallow water
        
        ; Seems like a timer to control how often to change the sprite's frame
        ; If frame counter < 9
        LDA $0356 : INC A : AND.b #$0F : STA $0356
        
        CMP.b #$09 : BCC BRANCH_ALPHA
        
        STZ $0356
        
        LDA $0355 : INC A : AND.b #$03 : STA $0355
        
        CMP.b #$03 : BNE BRANCH_ALPHA
        
        STZ $0355
    
    BRANCH_ALPHA:
    
        ; See if Link has a shield
        LDA $7EF35A : TAY
        
        ; See which direction Link is facing
        ; Probably positions the water/grass sprite appropriately
        LDA $0323 : LSR A : ADD $AECD, Y : TAY
        
        LDA $01 : ADD $98DB, Y : STA $07
        LDA $00 : ADD $98E7, Y : STA $06
        
        ; $8D = secondary timer * 4
        LDA $0355 : ASL #2 : STA $8D
        
        PHY
        
        ; ???? $72 apparently is assumed to be even at all times.
        LDX $72
        
        LDA $A11C, X : STA $74
        LDA $A11D, X : STA $75
        
        LDY $04
        
        LDA ($74), Y : TAX
        
        PLY
        
        ; See if Link is standing in grass
        ; Nope... standing in water
        LDA $0351 : CMP.b #$02 : BNE BRANCH_BETA
        
        LDY.b #$06
    
    BRANCH_THETA:
    
        LDA .unknown_0, Y : CMP $0354 : BNE BRANCH_GAMMA
        
        STZ $8D
        
        BRA BRANCH_DELTA
    
    BRANCH_GAMMA:
    
        DEY : BPL BRANCH_THETA
    
    BRANCH_DELTA:
    
        LDA $2E : CMP.b #$03 : BCC BRANCH_EPSILON
        
        SUB.b #$03
    
    BRANCH_EPSILON:
    
        ASL #2 : STA $8D
        
        LDA.b #$08 : ASL #2 : ADD $8D : TAY
        
        BRA BRANCH_ZETA
    
    BRANCH_BETA:
    
        LDA.b #$05 : ASL #2 : ADD $8D : TAY
    
    BRANCH_ZETA:
    
        REP #$30
        
        TYA : AND.w #$00FF : TAY
        
        TXA : AND.w #$00FF : ADD $0352 : TAX
        
        LDA $85CF, Y : AND.w #$CFFF : ORA $035D : STA $0802, X
        
        LDA $85D1, Y : ORA $035D : STA $0806, X
        
        LDA $06 : STA $0800, X
        
        XBA : ADD.w #$0800 : XBA : STA $0804, X
        
        TXA : LSR #2 : TAX
        
        STZ $0A20, X
        
        SEP #$30
        
        RTS
    }

; ==============================================================================

    ; \unused (Not sure if really unused yet.)
    ; $6AF9D-$6AFA5 DATA
    pool PlayerOam_Unused_0:
    {
    
    .offsets
        db 0, 0, 0, 1, 0, 1, 1, 1
        db 0
    }

; ==============================================================================

    ; \unused (Not sure if really unused yet.)
    ; $6AFA6-$6AFBF LOCAL
    PlayerOam_Unused_0:
    {
        SEP #$30
        
        LDX $2E
        
        LDA $0354 : CMP.b #$19 : BNE .alpha
        
        LDA $A131, X : TAX
    
    .alpha
    
        LDA .offsets, X : ADD $01 : STA $01
        
        REP #$30
        
        RTS
    }

; ==============================================================================

    ; *$6AFC0-$6AFDC LOCAL
    PlayerOam_GetRelativeHighBit:
    {
        ; In general this seems to take an offset for a sprite and figure out
        ; if its position relative to Link and the screen will require the 9th
        ; bit of the X coordinate to be set
        
        REP #$20
        
        ; sign extend the value in the accumulator to 16-bits
        AND.w #$00FF : CMP.w #$0080 : BCC .positive
        
        ORA.w #$FF00
    
    .positive
    
        ADD $22 : SUB $E2 : XBA : AND.w #$0001 : STA $03FA
        
        SEP #$20
        
        RTS
    }

; ==============================================================================

